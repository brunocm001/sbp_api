{% extends "admin/base.html" %}

{% block title %}Dashboard - SocialBoost Pro{% endblock %}

{% block page_title %}Dashboard{% endblock %}

{% block content %}
<div class="row row-deck row-cards">
    <!-- Statistiques générales -->
    <div class="col-sm-6 col-lg-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="subheader">Commandes totales</div>
                </div>
                <div class="h1 mb-3">{{ stats.total_orders }}</div>
                <div class="d-flex mb-2">
                    <div>En cours: {{ stats.pending_orders }}</div>
                    <div class="ms-auto">
                        <span class="text-green d-inline-flex align-items-center lh-1">
                            {{ stats.completed_orders }} terminées
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-sm-6 col-lg-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="subheader">Chiffre d'affaires</div>
                </div>
                <div class="h1 mb-3">{{ "%.2f"|format(stats.total_revenue) }} €</div>
                <div class="d-flex mb-2">
                    <div>Ce mois: {{ "%.2f"|format(stats.monthly_revenue) }} €</div>
                    <div class="ms-auto">
                        <span class="text-green d-inline-flex align-items-center lh-1">
                            +{{ stats.revenue_growth }}%
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-sm-6 col-lg-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="subheader">Tickets support</div>
                </div>
                <div class="h1 mb-3">{{ stats.total_tickets }}</div>
                <div class="d-flex mb-2">
                    <div>Ouverts: {{ stats.open_tickets }}</div>
                    <div class="ms-auto">
                        <span class="text-yellow d-inline-flex align-items-center lh-1">
                            {{ stats.avg_response_time }}h
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-sm-6 col-lg-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="subheader">Services actifs</div>
                </div>
                <div class="h1 mb-3">{{ stats.active_services }}</div>
                <div class="d-flex mb-2">
                    <div>Plateformes: {{ stats.platforms_count }}</div>
                    <div class="ms-auto">
                        <span class="text-blue d-inline-flex align-items-center lh-1">
                            {{ stats.service_types_count }} types
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Graphiques -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Commandes par mois</h3>
            </div>
            <div class="card-body">
                <div id="chart-orders" style="height: 300px"></div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Répartition par plateforme</h3>
            </div>
            <div class="card-body">
                <div id="chart-platforms" style="height: 300px"></div>
            </div>
        </div>
    </div>
    
    <!-- Dernières commandes -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Dernières commandes</h3>
                <div class="card-actions">
                    <a href="/admin/orders" class="btn btn-primary btn-sm">
                        Voir toutes
                    </a>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table card-table table-vcenter text-nowrap">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Service</th>
                            <th>Client</th>
                            <th>Montant</th>
                            <th>Statut</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in recent_orders %}
                        <tr>
                            <td>{{ order.id[:8] }}...</td>
                            <td>{{ order.service_type.name }}</td>
                            <td>{{ order.email or "Anonyme" }}</td>
                            <td>{{ "%.2f"|format(order.price_total) }} €</td>
                            <td>
                                <span class="badge bg-{{ order.status_color }}">
                                    {{ order.status_label }}
                                </span>
                            </td>
                            <td>{{ order.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Tickets récents -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Tickets récents</h3>
                <div class="card-actions">
                    <a href="/admin/support-tickets" class="btn btn-primary btn-sm">
                        Voir tous
                    </a>
                </div>
            </div>
            <div class="list-group list-group-flush">
                {% for ticket in recent_tickets %}
                <div class="list-group-item">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <span class="status-dot status-dot-animated bg-{{ ticket.status_color }}"></span>
                        </div>
                        <div class="col text-truncate">
                            <a href="/admin/support-tickets/{{ ticket.id }}" class="text-body d-block">
                                {{ ticket.email }}
                            </a>
                            <div class="d-block text-muted text-truncate mt-n1">
                                {{ ticket.message[:50] }}...
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="text-muted">{{ ticket.created_at.strftime('%d/%m') }}</div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
// Graphique des commandes par mois
var optionsOrders = {
    series: [{
        name: 'Commandes',
        data: {{ orders_chart_data | tojson }}
    }],
    chart: {
        type: 'area',
        height: 300,
        toolbar: {
            show: false
        }
    },
    dataLabels: {
        enabled: false
    },
    stroke: {
        curve: 'smooth'
    },
    xaxis: {
        categories: {{ orders_chart_categories | tojson }}
    },
    tooltip: {
        x: {
            format: 'dd/MM/yy HH:mm'
        },
    },
};

var chartOrders = new ApexCharts(document.querySelector("#chart-orders"), optionsOrders);
chartOrders.render();

// Graphique des plateformes
var optionsPlatforms = {
    series: {{ platforms_chart_data | tojson }},
    chart: {
        type: 'donut',
        height: 300
    },
    labels: {{ platforms_chart_labels | tojson }},
    responsive: [{
        breakpoint: 480,
        options: {
            chart: {
                width: 200
            },
            legend: {
                position: 'bottom'
            }
        }
    }]
};

var chartPlatforms = new ApexCharts(document.querySelector("#chart-platforms"), optionsPlatforms);
chartPlatforms.render();
</script>
{% endblock %} 